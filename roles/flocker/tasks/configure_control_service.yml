---
- name: flocker-ca create-control-certificate
  shell: "/ansible/flocker/bin/flocker-ca create-control-certificate {{ inventory_hostname }}"
  args:
    chdir: "{{ flocker_local_tempdir }}"
    creates: "control-{{ inventory_hostname }}.crt"
  delegate_to: 127.0.0.1

- name: copy user.crt to the node
  copy:
    src: "{{ flocker_local_tempdir }}/user.crt"
    dest: /etc/flocker/user.crt
  become: yes

- name: copy user.key to the node
  copy:
    src: "{{ flocker_local_tempdir }}/user.key"
    dest: /etc/flocker/user.key
    mode: 0600
  become: yes

- name: copy control key to the control node
  copy:
    src: "{{ flocker_local_tempdir }}/control-{{ inventory_hostname }}.key"
    dest: /etc/flocker/control-service.key
    mode: 0600
  sudo: yes

- name: copy control cert to the control node
  copy:
    src: "{{ flocker_local_tempdir }}/control-{{ inventory_hostname }}.crt"
    dest: /etc/flocker/control-service.crt
  become: yes

- name: write flockerctl wrapper to the master
  template:
    src: flockerctl.j2
    dest: /opt/bin/flockerctl
    mode: 0755
  become: yes
